---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import Icon from "../../components/Icon.astro";
import Button from "../../components/Button.astro";

const blogPosts = await getCollection("blog");

// Sort posts by publish date (newest first)
const sortedPosts = blogPosts.sort(
  (a, b) => b.data.publishDate.getTime() - a.data.publishDate.getTime()
);

// Group posts by year and month
const groupedPosts = sortedPosts.reduce(
  (acc, post) => {
    const year = post.data.publishDate.getFullYear();
    const month = post.data.publishDate.getMonth() + 1; // 1-12
    const monthName = post.data.publishDate.toLocaleDateString("uk-UA", {
      month: "long",
    });
    const key = `${year}-${month}`;

    if (!acc[key]) {
      acc[key] = {
        year,
        month,
        monthName,
        posts: [],
      };
    }

    acc[key].posts.push(post);
    return acc;
  },
  {} as Record<
    string,
    {
      year: number;
      month: number;
      monthName: string;
      posts: typeof blogPosts;
    }
  >
);

// Convert to array and sort by date (newest first)
const groupedArray = Object.values(groupedPosts).sort((a, b) => {
  if (a.year !== b.year) return b.year - a.year;
  // Compare months by their first post's date
  return (
    b.posts[0].data.publishDate.getTime() -
    a.posts[0].data.publishDate.getTime()
  );
});
---

<BaseLayout
  title="Блог"
  description="Блог Сергія Бабіча про технічні співбесіди та розробку"
>
  <main class="main-layout">
    <a href="/">
      <Icon name="arrow-left" />
      Назад
    </a>

    <h1>Блог</h1>

    {
      groupedArray.length === 0 ? (
        <p>Поки що немає опублікованих постів.</p>
      ) : (
        <div class="stack gap-lg">
          {groupedArray.map((group) => {
            const monthPadded = group.month.toString().padStart(2, "0");
            return (
              <section>
                <h2>
                  <a href={`/blog/${group.year}/${monthPadded}`}>
                    {group.monthName} {group.year}
                  </a>
                </h2>
                <ul class="stack gap-md">
                  {group.posts.map((post) => {
                    const postYear = post.data.publishDate.getFullYear();
                    const postDay = post.data.publishDate.getDate();
                    const postMonth = post.data.publishDate.getMonth() + 1;
                    const postMonthPadded = postMonth
                      .toString()
                      .padStart(2, "0");
                    const postDayPadded = postDay.toString().padStart(2, "0");
                    return (
                      <li>
                        <article>
                          <h3>
                            <a href={`/blog/${post.data.urlSlug}`}>
                              {post.data.title}
                            </a>
                          </h3>
                          <p>{post.data.description}</p>
                          <time datetime={post.data.publishDate.toISOString()}>
                            <a
                              href={`/blog/${postYear}/${postMonthPadded}/${postDayPadded}`}
                            >
                              {post.data.publishDate.toLocaleDateString(
                                "uk-UA",
                                {
                                  year: "numeric",
                                  month: "long",
                                  day: "numeric",
                                }
                              )}
                            </a>
                          </time>
                        </article>
                      </li>
                    );
                  })}
                </ul>
              </section>
            );
          })}
        </div>
      )
    }
  </main>
</BaseLayout>
